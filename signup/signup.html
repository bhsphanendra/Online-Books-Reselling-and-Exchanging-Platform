<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="signup.css">
    <title>Sign Up | Books Swap Hub</title>
</head>
<body>
    <main class="signup-container">
        <h1>Join Books Swap Hub</h1>
        <form id="signupForm">
            <div class="form-row">
                <div class="form-group">
                    <input type="text" id="firstname" name="firstname" placeholder="First Name" required>
                </div>
                <div class="form-group">
                    <input type="text" id="lastname" name="lastname" placeholder="Last Name" required>
                </div>
            </div>

            <div class="form-group">
                <input type="text" id="username" name="username" placeholder="Username" required>
            </div>

            <div class="form-group email-group">
                <input type="email" id="email" name="email" placeholder="Email" required>
                <button type="button" id="sendOtpBtn" class="otp-btn">Send OTP</button>
            </div>

            <div class="form-group otp-group" style="display: none;">
                <input type="text" id="otp" name="otp" placeholder="Enter OTP" required>
                <button type="button" id="verifyOtpBtn" class="otp-btn">Verify OTP</button>
            </div>

            <div class="form-group">
                <input type="tel" id="mobile" name="mobile" placeholder="Mobile Number" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <input type="date" id="dob" name="dob" placeholder="Date of Birth" required>
                </div>
                <div class="form-group">
                    <select id="gender" name="gender" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <select id="role" name="role" required>
                    <option value="">Select Role</option>
                    <option value="user">User</option>
                    <option value="seller">Seller</option>
                </select>
            </div>

            <div class="form-group">
                <input type="password" id="password" name="password" placeholder="Password" required>
            </div>

            <div class="form-group">
                <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm Password" required>
            </div>

            <div class="terms-checkbox">
                <label>
                    <input type="checkbox" required>
                    <span>I accept the Terms of Use & Privacy Policy</span>
                </label>
            </div>

            <button type="submit" id="submitBtn" disabled>Create Account</button>

            <div class="login-link">
                <p>Already have an account? <a href="../login.html">Login here</a></p>
            </div>
        </form>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const signupForm = document.getElementById('signupForm');
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            const emailInput = document.getElementById('email');
            const otpInput = document.getElementById('otp');
            const otpGroup = document.querySelector('.otp-group');
            const submitBtn = document.getElementById('submitBtn');
            
            let generatedOtp = '';
            let isOtpVerified = false;

            // Send OTP button click handler
            sendOtpBtn.addEventListener('click', async function() {
                const email = emailInput.value.trim();
                
                if (!email) {
                    alert('Please enter your email first');
                    return;
                }

                try {
                    // Generate a 6-digit OTP
                    generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    // Send OTP to server to email it to the user
                    const response = await fetch('send_otp.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            otp: generatedOtp
                        })
                    });

                    const responseText = await response.text();
                    
                    try {
                        // Try to parse as JSON
                        const data = JSON.parse(responseText);
                        
                        if (data.success) {
                            alert('OTP sent to your email!');
                            otpGroup.style.display = 'flex';
                            sendOtpBtn.disabled = true;
                        } else {
                            alert(data.message || 'Failed to send OTP');
                            console.error('Server error:', data);
                        }
                    } catch (e) {
                        console.error('Raw server response:', responseText);
                        alert('Server returned an invalid response. Check console for details.');
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    alert('An error occurred while sending OTP');
                }
            });

            // Verify OTP button click handler
            verifyOtpBtn.addEventListener('click', function() {
                const enteredOtp = otpInput.value.trim();
                
                if (!enteredOtp) {
                    alert('Please enter the OTP');
                    return;
                }

                if (enteredOtp === generatedOtp) {
                    isOtpVerified = true;
                    submitBtn.disabled = false;
                    otpInput.disabled = true;
                    verifyOtpBtn.disabled = true;
                    alert('OTP verified successfully!');
                } else {
                    alert('Invalid OTP. Please try again.');
                }
            });

            // Form submission handler
            signupForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!isOtpVerified) {
                    alert('Please verify your email with OTP first');
                    return;
                }

                try {
                    // Create FormData object
                    const formData = new FormData(this);
                    
                    // Send POST request to signup.php
                    const response = await fetch('signup.php', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert(data.message);
                        setTimeout(() => {
                            window.location.replace(data.redirect);
                        }, 500);
                    } else {
                        alert(data.message || 'Error occurred during signup');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred during signup');
                }
            });
        });
    </script>
</body>
</html>